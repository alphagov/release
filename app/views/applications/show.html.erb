<% content_for :page_title, @application.name %>

<%= title @application.name %>

<%= render 'status_notes', application: @application %>

<ul class="tabs">
  <li class="active">
    <%= link_to "Deploy status", @application %>
  </li>
  <% if current_user.may_deploy? %>
    <li>
      <%= link_to "Edit", edit_application_path(@application) %>
    </li>
  <% end %>
  <li>
    <%= link_to "Recent deployments", application_deployments_path(@application) %>
  </li>
</ul>

<% if @application.archived %>
  <p>This application has been marked as archived.</p>
<% end %>

<%= render 'status_notes', application: @application %>

<% if @github_available %>
  <table class="govuk-table">
    <thead class="govuk-table__head">
      <tr class="govuk-table__row">
        <th class="govuk-table__header" scope="col">Release</th>
        <th class="govuk-table__header" scope="col">Commit</th>
      </tr>
    </thead>
    <tbody class="govuk-table__body">
      <% @commits.each do |commit| %>
        <tr class="govuk-table__row">
          <% if tags = @tags_by_commit[commit[:sha]] %>
            <th class="govuk-table__cell">
              <% tags.each do |tag| %>
                <%= link_to "Deploy #{tag[:name]}", deploy_application_path(@application, tag: tag[:name]) %>

                <% if deployments = @latest_deploy_to_each_environment_by_version[tag[:name]] %>
                  <% deployments.each do |deployment| %>
                    <div style="white-space:nowrap;">
                      <%= environment_tag deployment.environment %>
                      <%= time_tag(deployment.created_at, human_datetime(deployment.created_at)) %><br/>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
            </th>
          <% else %>
            <th class="govuk-table__header"></th>
          <% end %>

          <td class="govuk-table__cell govuk-!-f-16">
            <% summary, body = commit[:commit][:message].split(/\n/, 2) %>
            <a href="<%= "#{@application.repo_url}/commit/#{commit[:sha]}" %>" target="_blank"><%= summary %></a>

            <br/>

            <% if commit[:author] %>
              <img height="20" width="20" class="avatar" src="<%= commit[:author][:avatar_url] %>" alt="" />
            <% end %>
            <% if commit[:commit][:author] %>
              <span class="name">
                <%= commit[:commit][:author][:name] %>
              </span>
            <% end %>

            <% if commit[:commit][:author] %>
              <% commit_date = commit[:commit][:author][:date] %>
              <span class="date"><%= commit_date.to_date.to_s(:short) =%></span>
              <span class="time"><%= commit_date.to_date.to_s(:govuk_time) =%></span>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <div class="alert alert-error">
    <div>Couldn't get data from GitHub:</div>
    <div><%= @github_error %></div>
  </div>
<% end %>

<%= h2 "Whatâ€™s where?" %>

<table class="govuk-table">
  <thead class="govuk-table__head">
    <tr class="govuk-table__row">
      <th class="govuk-table__header">Environment</th>
      <th class="govuk-table__header">Version</th>
      <th class="govuk-table__header">Previous version</th>
    </tr>
  </thead>
  <tbody class="govuk-table__body">
    <% @application.latest_deploy_to_each_environment.each do |environment, deployment| %>
      <tr class="govuk-table__row">
        <th class="govuk-table__header"><%= environment_tag(environment) %></th>
        <td class="govuk-table__cell">
          <%= github_tag_link_to(@application, deployment.version) %>
          at
          <%= human_datetime(deployment.created_at) %>
        </td>
        <td class="govuk-table__cell">
          <% if deployment.previous_deployment %>
            <%= github_tag_link_to(@application, deployment.previous_deployment.version) %>
            at
            <%= human_datetime(deployment.previous_deployment.created_at) %>
          <% else %>
            N/A
          <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>
